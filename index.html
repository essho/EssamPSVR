<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>جولة 360 المتكاملة</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <script>
        // 1. مكون توجيه العناصر للكاميرا
        AFRAME.registerComponent('look-at', {
            schema: { type: 'selector' },
            tick: function () { if(this.data) this.el.object3D.lookAt(this.data.object3D.position); }
        });

        // 2. مكون خاص لتفعيل "القرص" (Pinch) كأنه نقرة زر
        AFRAME.registerComponent('hand-click-trigger', {
            init: function () {
                this.el.addEventListener('pinchstarted', (evt) => {
                    // عند القيام بالقرص، نتحقق مما يشير إليه الليزر
                    const raycaster = this.el.components.raycaster;
                    if (raycaster && raycaster.intersectedEls.length > 0) {
                        const target = raycaster.intersectedEls[0];
                        // إذا كان الهدف قابلاً للنقر، نرسل له أمر النقر
                        if (target.classList.contains('clickable')) {
                            target.emit('click');
                            // تأثير صوتي أو بصري بسيط (اختياري)
                            console.log("Pinch Clicked on:", target.id);
                        }
                    }
                });
            }
        });

        // 3. مكون الزوم
        AFRAME.registerComponent('zoom-controls', {
            schema: { min: {default: 30}, max: {default: 80}, sensitivity: {default: 1.5} },
            init: function () {
                this.camera = this.el.components.camera.camera;
                this.lookControls = this.el.components['look-controls'];
                window.addEventListener('wheel', (e) => { this.zoom(e.deltaY > 0 ? 1 : -1); });
                this.touchStartDistance = 0; this.isPinching = false;
                window.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        this.isPinching = true;
                        if(this.lookControls) this.lookControls.data.touchEnabled = false;
                        this.touchStartDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    }
                });
                window.addEventListener('touchmove', (e) => {
                    if (this.isPinching && e.touches.length === 2) {
                        const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        this.zoom((this.touchStartDistance - dist) * 0.05);
                        this.touchStartDistance = dist;
                    }
                });
                window.addEventListener('touchend', (e) => {
                    if (e.touches.length < 2) { this.isPinching = false; if(this.lookControls) this.lookControls.data.touchEnabled = true; }
                });
            },
            zoom: function (delta) {
                let fov = this.camera.fov + delta * this.data.sensitivity;
                fov = Math.min(Math.max(this.data.min, fov), this.data.max);
                this.camera.fov = fov;
                this.camera.updateProjectionMatrix();
            }
        });
    </script>
</head>
<body>

    <a-scene renderer="antialias: true; colorManagement: true;" cursor="rayOrigin: mouse" raycaster="objects: .clickable">
        
        <a-assets>
            <img id="current-img" src="./panoramas/scene-1.jpg">
        </a-assets>

        <a-sky id="sky" src="#current-img" rotation="0 -90 0"></a-sky>
        <a-entity id="hotspots"></a-entity>

        <a-entity id="vr-info-panel" visible="false" position="0 0 -2" scale="0 0 0">
            <a-animation attribute="scale" begin="open" to="1 1 1" dur="200"></a-animation>
            <a-animation attribute="scale" begin="close" to="0 0 0" dur="200"></a-animation>

            <a-plane color="#222" opacity="0.9" width="2" height="1.2" class="clickable"></a-plane>
            
            <a-text id="vr-info-text" value="Info Text" align="center" width="1.8" color="white" position="0 0.2 0.01"></a-text>
            
            <a-entity id="btn-close" position="0 -0.4 0.02" class="clickable">
                <a-plane color="#c0392b" width="0.6" height="0.2"></a-plane>
                <a-text value="CLOSE" align="center" width="3" position="0 0 0.01"></a-text>
            </a-entity>
        </a-entity>

        <a-entity id="rig" position="0 1.6 0">
            <a-camera id="camera" look-controls="magicWindowTrackingEnabled: true; touchEnabled: true; reverseMouseDrag: false" wasd-controls="enabled: false" zoom-controls></a-camera>

            <a-entity id="left-hand" 
                      hand-tracking-controls="hand: left"
                      raycaster="objects: .clickable; showLine: true; far: 5; lineColor: red; lineOpacity: 0.7"
                      hand-click-trigger>
            </a-entity>

            <a-entity id="right-hand" 
                      hand-tracking-controls="hand: right"
                      raycaster="objects: .clickable; showLine: true; far: 5; lineColor: red; lineOpacity: 0.7"
                      hand-click-trigger>
            </a-entity>

            <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 10; lineColor: red;"></a-entity>
            <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 10; lineColor: red;"></a-entity>
        </a-entity>

    </a-scene>

    <script>
        const sky = document.getElementById('sky');
        const container = document.getElementById('hotspots');
        const infoPanel = document.getElementById('vr-info-panel');
        const infoText = document.getElementById('vr-info-text');
        const closeBtn = document.getElementById('btn-close');

        // 1. تحميل البداية
        const initialSrc = document.getElementById('current-img').getAttribute('src');
        loadExternalData(initialSrc);

        // 2. برمجة زر الإغلاق (الحل الجذري لمشكلة عدم الإغلاق)
        closeBtn.addEventListener('click', function() {
            // نخفي اللوحة بتصغير حجمها (Animation) أو إخفائها مباشرة
            infoPanel.setAttribute('visible', false);
            infoPanel.setAttribute('scale', '0 0 0'); // لضمان اختفائها تماماً
        });

        // 3. دالة تغيير المشهد
        function changeScene(imagePath) {
            // نتأكد من إغلاق أي لوحة مفتوحة أولاً
            infoPanel.setAttribute('visible', false);

            const fadeEl = document.createElement('a-sphere');
            fadeEl.setAttribute('radius', 0.1);
            fadeEl.setAttribute('material', 'color: black; side: double; transparent: true; opacity: 0');
            document.getElementById('camera').appendChild(fadeEl);

            let op = 0;
            const fadeOut = setInterval(() => {
                op += 0.1;
                fadeEl.setAttribute('opacity', op);
                if (op >= 1) {
                    clearInterval(fadeOut);
                    
                    sky.setAttribute('src', imagePath);
                    container.innerHTML = ''; 

                    loadExternalData(imagePath);

                    let op2 = 1;
                    const fadeIn = setInterval(() => {
                        op2 -= 0.1;
                        fadeEl.setAttribute('opacity', op2);
                        if (op2 <= 0) {
                            clearInterval(fadeIn);
                            if(fadeEl.parentNode) fadeEl.parentNode.removeChild(fadeEl);
                        }
                    }, 50);
                }
            }, 50);
        }

        // 4. تحميل البيانات JSON
        function loadExternalData(imagePath) {
            const filename = imagePath.split('/').pop().split('.')[0];
            const jsonPath = `./hotspots/${filename}.json`;

            fetch(jsonPath)
                .then(res => { if (!res.ok) throw new Error("No JSON"); return res.json(); })
                .then(data => data.forEach(spot => createHotspot(spot)))
                .catch(err => console.log("No hotspots found for this scene"));
        }

        // 5. إنشاء النقاط
        function createHotspot(data) {
            const el = document.createElement('a-entity');
            el.setAttribute('position', `${data.x} ${data.y} ${data.z}`);
            el.setAttribute('look-at', '[camera]');
            
            let shape;
            if (data.type === 'link') {
                // شكل الانتقال
                shape = document.createElement('a-entity');
                
                const sphere = document.createElement('a-sphere');
                sphere.setAttribute('radius', '0.3');
                sphere.setAttribute('color', '#2ecc71');
                sphere.setAttribute('opacity', '0.9');
                shape.appendChild(sphere);
                
                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.35');
                ring.setAttribute('radius-outer', '0.4');
                ring.setAttribute('color', 'white');
                shape.appendChild(ring);

            } else {
                // شكل المعلومات
                shape = document.createElement('a-box');
                shape.setAttribute('color', '#3498db');
                shape.setAttribute('scale', '0.4 0.4 0.4');
                shape.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear');
            }

            // *** هام جداً: إضافة كلاس clickable ***
            shape.setAttribute('class', 'clickable'); 
            
            // إضافة نبض
            shape.setAttribute('animation__scale', 'property: scale; dir: alternate; dur: 1000; loop: true; to: 1.1 1.1 1.1');

            el.appendChild(shape);

            // 6. ربط حدث النقر (يعمل مع الماوس، اللمس، والقرص باليد)
            shape.addEventListener('click', () => {
                console.log("Clicked:", data.type); // للتأكد في الكونسول
                
                if (data.type === 'link') {
                    changeScene(data.target);
                } else if (data.type === 'info') {
                    showInfoPanel(data.text, el.getAttribute('position'));
                }
            });

            container.appendChild(el);
        }

        // 7. دالة إظهار اللوحة
        function showInfoPanel(text, position) {
            infoText.setAttribute('value', text);
            
            // وضع اللوحة أمام النقطة
            infoPanel.setAttribute('position', `${position.x} ${position.y + 0.6} ${position.z}`);
            infoPanel.setAttribute('look-at', '[camera]');
            
            // الإظهار
            infoPanel.setAttribute('visible', true);
            infoPanel.setAttribute('scale', '1 1 1');
        }
    </script>
</body>
</html>