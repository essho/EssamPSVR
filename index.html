<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>جولة 360 (Native VR)</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <script>
        // 1. مكون التوجيه (أساسي)
        AFRAME.registerComponent('look-at', {
            schema: { type: 'selector' },
            tick: function () { if(this.data) this.el.object3D.lookAt(this.data.object3D.position); }
        });

        // 2. مكون الزوم (للموبايل/الكمبيوتر فقط)
        AFRAME.registerComponent('zoom-controls', {
            schema: { min: {default: 30}, max: {default: 80} },
            init: function () {
                this.camera = this.el.components.camera.camera;
                window.addEventListener('wheel', (e) => {
                    this.camera.fov += e.deltaY * 0.05;
                    this.camera.fov = Math.max(30, Math.min(80, this.camera.fov));
                    this.camera.updateProjectionMatrix();
                });
            }
        });
    </script>
</head>
<body>

    <a-scene renderer="antialias: true; colorManagement: true;" 
             cursor="rayOrigin: mouse" 
             raycaster="objects: .clickable">
        
        <a-assets>
            <img id="current-img" src="./panoramas/scene-1.jpg">
        </a-assets>

        <a-sky id="sky" src="#current-img" rotation="0 -90 0" class="clickable" onclick="hideInfoPanel()"></a-sky>

        <a-entity id="hotspots">
            <a-sphere position="0 1.6 -3" radius="0.2" color="red" class="clickable"
                      onclick="alert('النظام يعمل')"
                      animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 500">
            </a-sphere>
        </a-entity>

        <a-entity id="info-panel" visible="false" position="0 0 -2" scale="0 0 0">
            <a-plane color="black" opacity="0.8" width="2" height="1"></a-plane>
            <a-text id="info-text" value="Info" align="center" color="white" width="1.8"></a-text>
        </a-entity>

<a-entity id="rig" position="0 1.6 0">
            
            <a-camera id="camera" look-controls="magicWindowTrackingEnabled: true; touchEnabled: true" zoom-controls>
                <a-entity cursor="fuse: false" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: white; shader: flat" visible="false"></a-entity>
            </a-camera>

            <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 10; lineColor: #FF0000"></a-entity>
            <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 10; lineColor: #FF0000"></a-entity>

            <a-entity id="left-hand" hand-tracking-controls="hand: left; modelStyle: dots">
                <a-entity raycaster="objects: .clickable; showLine: true; far: 5; origin: 0 0 0; direction: 0 0 -1"
                          position="0 0 0"
                          rotation="-15 0 0" 
                          line="color: #00FF00; opacity: 0.8; start: 0 0 0; end: 0 0 -5">
                </a-entity>
            </a-entity>

            <a-entity id="right-hand" hand-tracking-controls="hand: right; modelStyle: dots">
                <a-entity raycaster="objects: .clickable; showLine: true; far: 5; origin: 0 0 0; direction: 0 0 -1"
                          position="0 0 0"
                          rotation="-15 0 0" 
                          line="color: #00FF00; opacity: 0.8; start: 0 0 0; end: 0 0 -5">
                </a-entity>
            </a-entity>

        </a-entity>
		
    </a-scene>

    <script>
        const sky = document.getElementById('sky');
        const container = document.getElementById('hotspots');
        const infoPanel = document.getElementById('info-panel');
        const infoText = document.getElementById('info-text');
        let hideTimer;

        // التحميل الأولي
        const startImg = document.getElementById('current-img').getAttribute('src');
        loadExternalData(startImg);

        // تحميل البيانات
        function loadExternalData(imagePath) {
            const filename = imagePath.split('/').pop().split('.')[0];
            const jsonPath = `./hotspots/${filename}.json`;

            fetch(jsonPath)
                .then(res => { if (!res.ok) throw new Error("No JSON"); return res.json(); })
                .then(data => {
                    container.innerHTML = ''; 
                    data.forEach(spot => createHotspot(spot));
                })
                .catch(err => console.log("Default scene active"));
        }

        // إنشاء النقاط
        function createHotspot(data) {
            const el = document.createElement('a-entity');
            el.setAttribute('position', `${data.x} ${data.y} ${data.z}`);
            el.setAttribute('look-at', '[camera]');

            let shape;
            if (data.type === 'link') {
                shape = document.createElement('a-sphere');
                shape.setAttribute('radius', '0.3');
                shape.setAttribute('color', '#2ecc71');
                shape.setAttribute('opacity', '0.9');
                
                const ring = document.createElement('a-ring');
                ring.setAttribute('color', 'white');
                ring.setAttribute('radius-inner', '0.35');
                ring.setAttribute('radius-outer', '0.4');
                el.appendChild(ring);
            } else {
                shape = document.createElement('a-box');
                shape.setAttribute('scale', '0.4 0.4 0.4');
                shape.setAttribute('color', '#3498db'); 
                shape.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000');
            }

            // الكلاس الضروري للتفاعل
            shape.setAttribute('class', 'clickable');
            shape.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1000; loop: true; to: 1.1 1.1 1.1');

            el.appendChild(shape);

            // التفاعل الموحد (يعمل مع كل الأجهزة)
            shape.addEventListener('click', (evt) => {
                // إيقاف انتشار الحدث
                if(evt) evt.stopPropagation();
                // تشغيل الحدث
                handleInteraction(data, el.getAttribute('position'));
            });

            container.appendChild(el);
        }

        // معالج التفاعل الموحد
        function handleInteraction(data, pos) {
            if (data.type === 'link') {
                changeScene(data.target);
            } else if (data.type === 'info') {
                showInfoPanel(data.text, pos);
            }
        }

        function changeScene(newUrl) {
            hideInfoPanel();
            sky.setAttribute('color', '#000');
            setTimeout(() => {
                sky.setAttribute('src', newUrl);
                sky.removeAttribute('color');
                loadExternalData(newUrl);
            }, 300);
        }

        function showInfoPanel(text, pos) {
            if (hideTimer) clearTimeout(hideTimer);

            infoText.setAttribute('value', text);
            // تحويل الإحداثيات لأرقام لضمان الجمع
            const x = parseFloat(pos.x);
            const y = parseFloat(pos.y) + 0.6;
            const z = parseFloat(pos.z);

            infoPanel.setAttribute('position', `${x} ${y} ${z}`);
            infoPanel.setAttribute('look-at', '[camera]');
            infoPanel.setAttribute('visible', true);
            infoPanel.setAttribute('scale', '1 1 1');

            // الإغلاق التلقائي بعد 3 ثواني
            hideTimer = setTimeout(() => {
                hideInfoPanel();
            }, 3000);
        }

        function hideInfoPanel() {
            infoPanel.setAttribute('visible', false);
            infoPanel.setAttribute('scale', '0 0 0');
            if (hideTimer) clearTimeout(hideTimer);
        }
    </script>
</body>
</html>